<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FloorViz — 3D Floor Plan Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a38;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --text: #e8e8f0;
    --text-muted: #666680;
    --success: #00ff88;
    --wall-color: #c8b89a;
    --floor-color: #1e1e2e;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    overflow: hidden;
  }

  /* ── Layout ── */
  .app {
    display: grid;
    grid-template-columns: 300px 1fr;
    grid-template-rows: 56px 1fr;
    height: 100vh;
  }

  /* ── Header ── */
  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    gap: 16px;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo span { color: var(--accent); }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-muted);
    margin-left: auto;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.3s;
  }

  .status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .status-dot.error { background: var(--accent2); }

  /* ── Sidebar ── */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-label {
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  /* Upload zone */
  .upload-zone {
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: rgba(0, 229, 255, 0.04);
  }

  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon {
    font-size: 28px;
    margin-bottom: 8px;
    display: block;
  }

  .upload-text {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .upload-text strong {
    color: var(--accent);
    font-weight: 500;
  }

  /* Fields */
  .field {
    margin-bottom: 12px;
  }

  .field label {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 6px;
    letter-spacing: 0.5px;
  }

  .field label span {
    color: var(--accent);
    font-weight: 500;
  }

  .field input[type="range"] {
    width: 100%;
    appearance: none;
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }

  .field input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 8px var(--accent);
  }

  .field input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .field input[type="number"]:focus {
    border-color: var(--accent);
  }

  /* Process button */
  .btn-process {
    width: 100%;
    padding: 12px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .btn-process:hover { background: #33eeff; transform: translateY(-1px); }
  .btn-process:active { transform: translateY(0); }
  .btn-process:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; transform: none; }

  .btn-process.loading::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: -100%;
    width: 100%;
    height: 2px;
    background: rgba(0,0,0,0.3);
    animation: loading-bar 1.5s infinite;
  }

  @keyframes loading-bar {
    to { left: 100%; }
  }

  /* Stats */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .stat-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 20px;
    color: var(--accent);
    line-height: 1;
  }

  .stat-label {
    font-size: 9px;
    color: var(--text-muted);
    margin-top: 4px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* Controls */
  .controls-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
  }

  .control-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .control-btn.active {
    border-color: var(--accent);
    background: rgba(0, 229, 255, 0.08);
    color: var(--accent);
  }

  .kbd {
    margin-left: auto;
    padding: 2px 6px;
    background: var(--border);
    border-radius: 3px;
    font-size: 9px;
    color: var(--text-muted);
  }

  /* Log */
  .log {
    flex: 1;
    overflow-y: auto;
    padding: 12px 20px;
    font-size: 10px;
    line-height: 1.8;
    color: var(--text-muted);
  }

  .log-entry { display: flex; gap: 8px; }
  .log-entry.info .log-tag { color: var(--accent); }
  .log-entry.success .log-tag { color: var(--success); }
  .log-entry.error .log-tag { color: var(--accent2); }
  .log-entry.warn .log-tag { color: #ffd166; }

  /* ── Canvas ── */
  #canvas-container {
    position: relative;
    background: var(--bg);
    overflow: hidden;
  }

  #three-canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Empty state */
  .empty-state {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    pointer-events: none;
  }

  .empty-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
  }

  .empty-text {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: var(--surface2);
    letter-spacing: -1px;
    position: relative;
  }

  .empty-sub {
    font-size: 11px;
    color: var(--text-muted);
    position: relative;
    letter-spacing: 1px;
  }

  /* Corner info */
  .corner-info {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    font-size: 10px;
    color: var(--text-muted);
  }

  .corner-tag {
    padding: 4px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
  }

  /* Warnings banner */
  .warnings-banner {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 107, 53, 0.15);
    border: 1px solid var(--accent2);
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 11px;
    color: var(--accent2);
    display: none;
    max-width: 400px;
    text-align: center;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<div class="app">

  <!-- Header -->
  <header>
    <div class="logo">Floor<span>Viz</span></div>
    <div style="font-size:11px; color:var(--text-muted); margin-left:8px;">3D Floor Plan Viewer</div>
    <div class="status-pill">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">Not connected</span>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">

    <!-- Upload -->
    <div class="sidebar-section">
      <div class="sidebar-label">Floor Plan</div>
      <div class="upload-zone" id="upload-zone">
        <input type="file" id="file-input" accept=".dxf">
        <span class="upload-icon">⬡</span>
        <div class="upload-text">
          <strong>Drop DXF file</strong> or click<br>
          <span id="file-name">No file selected</span>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div class="sidebar-section">
      <div class="sidebar-label">Processing</div>
      <div class="field">
        <label>Scale (1 unit = X meters) <span id="scale-val">1.0</span></label>
        <input type="range" id="scale" min="0.001" max="2" step="0.001" value="1.0"
          oninput="document.getElementById('scale-val').textContent=parseFloat(this.value).toFixed(3)">
      </div>
      <div class="field">
        <label>Wall Height (m) <span id="height-val">3.0</span></label>
        <input type="range" id="wall-height" min="1" max="6" step="0.1" value="3.0"
          oninput="document.getElementById('height-val').textContent=parseFloat(this.value).toFixed(1)">
      </div>
      <div class="field">
        <label>Wall Thickness (m) <span id="thick-val">0.20</span></label>
        <input type="range" id="wall-thickness" min="0.05" max="0.8" step="0.01" value="0.2"
          oninput="document.getElementById('thick-val').textContent=parseFloat(this.value).toFixed(2)">
      </div>
      <button class="btn-process" id="process-btn" onclick="uploadAndProcess()" disabled>
        Upload & Process
      </button>
    </div>

    <!-- Stats -->
    <div class="sidebar-section">
      <div class="sidebar-label">Model Stats</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="stat-walls">—</div>
          <div class="stat-label">Walls</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-length">—</div>
          <div class="stat-label">Total (m)</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-time">—</div>
          <div class="stat-label">ms</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-size">—</div>
          <div class="stat-label">m²</div>
        </div>
      </div>
    </div>

    <!-- View Controls -->
    <div class="sidebar-section">
      <div class="sidebar-label">View</div>
      <div class="controls-list">
        <button class="control-btn" onclick="resetCamera()">⟳ Reset Camera <span class="kbd">R</span></button>
        <button class="control-btn" id="btn-top" onclick="toggleTopView()">⊙ Top View <span class="kbd">T</span></button>
        <button class="control-btn" id="btn-wireframe" onclick="toggleWireframe()">⬡ Wireframe <span class="kbd">W</span></button>
      </div>
    </div>

    <!-- Log -->
    <div class="log" id="log"></div>

  </aside>

  <!-- Canvas -->
  <div id="canvas-container">
    <canvas id="three-canvas"></canvas>

    <div class="empty-state" id="empty-state">
      <div class="empty-grid"></div>
      <div class="empty-text">NO MODEL</div>
      <div class="empty-sub">Upload a DXF file to begin →</div>
    </div>

    <div class="warnings-banner" id="warnings-banner"></div>

    <div class="corner-info">
      <div class="corner-tag" id="corner-size">—</div>
      <div class="corner-tag">Three.js r128</div>
    </div>
  </div>

</div>

<script>
// ─────────────────────────────────────────────────────────────────────────────
// Config
// ─────────────────────────────────────────────────────────────────────────────
const API_BASE = 'http://localhost:8000';

// ─────────────────────────────────────────────────────────────────────────────
// State
// ─────────────────────────────────────────────────────────────────────────────
let selectedFile = null;
let scene, camera, renderer, controls;
let buildingGroup = null;
let isTopView = false;
let isWireframe = false;
let animationId = null;

// ─────────────────────────────────────────────────────────────────────────────
// Logging
// ─────────────────────────────────────────────────────────────────────────────
function log(msg, type = 'info') {
  const el = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  const tags = { info: 'INFO', success: 'OK', error: 'ERR', warn: 'WARN' };
  entry.innerHTML = `<span class="log-tag">${tags[type]}</span><span>${msg}</span>`;
  el.appendChild(entry);
  el.scrollTop = el.scrollHeight;
}

// ─────────────────────────────────────────────────────────────────────────────
// API status check
// ─────────────────────────────────────────────────────────────────────────────
async function checkAPI() {
  try {
    const r = await fetch(`${API_BASE}/health`);
    if (r.ok) {
      setStatus('connected', 'API connected');
      log('Backend connected at ' + API_BASE, 'success');
    } else {
      setStatus('error', 'API error');
    }
  } catch {
    setStatus('error', 'Backend offline');
    log('Cannot reach backend at ' + API_BASE, 'error');
    log('Make sure uvicorn is running', 'warn');
  }
}

function setStatus(state, text) {
  const dot = document.getElementById('status-dot');
  const label = document.getElementById('status-text');
  dot.className = `status-dot ${state}`;
  label.textContent = text;
}

// ─────────────────────────────────────────────────────────────────────────────
// File handling
// ─────────────────────────────────────────────────────────────────────────────
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  selectedFile = file;
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('process-btn').disabled = false;
  log(`File selected: ${file.name} (${(file.size/1024).toFixed(1)}KB)`, 'info');
});

const uploadZone = document.getElementById('upload-zone');
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.name.endsWith('.dxf')) {
    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('process-btn').disabled = false;
    log(`File dropped: ${file.name}`, 'info');
  } else {
    log('Only .dxf files are supported', 'error');
  }
});

// ─────────────────────────────────────────────────────────────────────────────
// Upload & Process
// ─────────────────────────────────────────────────────────────────────────────
async function uploadAndProcess() {
  if (!selectedFile) return;

  const btn = document.getElementById('process-btn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.textContent = 'Uploading...';

  const scale = document.getElementById('scale').value;
  const wallHeight = document.getElementById('wall-height').value;
  const wallThickness = document.getElementById('wall-thickness').value;

  try {
    // Upload
    log('Uploading file...', 'info');
    const formData = new FormData();
    formData.append('file', selectedFile);

    const uploadRes = await fetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
    if (!uploadRes.ok) {
      const err = await uploadRes.json();
      throw new Error(err.detail || 'Upload failed');
    }
    const uploadData = await uploadRes.json();
    const jobId = uploadData.job_id;
    log(`Uploaded → job ${jobId.slice(0,8)}...`, 'success');

    // Process
    btn.textContent = 'Processing...';
    log('Processing floor plan...', 'info');

    const processRes = await fetch(
      `${API_BASE}/process/${jobId}?scale=${scale}&wall_height=${wallHeight}&wall_thickness=${wallThickness}`,
      { method: 'POST' }
    );
    if (!processRes.ok) {
      const err = await processRes.json();
      throw new Error(err.detail || 'Processing failed');
    }
    const result = await processRes.json();

    if (!result.success) throw new Error(result.error || 'Unknown error');

    log(`Detected ${result.model.metadata.wall_count} walls in ${result.processing_time_ms.toFixed(0)}ms`, 'success');

    // Warnings
    if (result.warnings && result.warnings.length > 0) {
      result.warnings.forEach(w => log(w, 'warn'));
      showWarnings(result.warnings);
    }

    // Render
    renderModel(result.model);
    updateStats(result);

  } catch (err) {
    log('Error: ' + err.message, 'error');
    setStatus('error', 'Processing failed');
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Upload & Process';
  }
}

// ─────────────────────────────────────────────────────────────────────────────
// Stats
// ─────────────────────────────────────────────────────────────────────────────
function updateStats(result) {
  const m = result.model.metadata;
  document.getElementById('stat-walls').textContent = m.wall_count;
  document.getElementById('stat-length').textContent = m.total_wall_length;
  document.getElementById('stat-time').textContent = Math.round(result.processing_time_ms);

  const b = m.bounds;
  if (b) {
    const area = ((b.maxx - b.minx) * (b.maxy - b.miny)).toFixed(0);
    document.getElementById('stat-size').textContent = area;
    document.getElementById('corner-size').textContent =
      `${(b.maxx - b.minx).toFixed(1)}m × ${(b.maxy - b.miny).toFixed(1)}m`;
  }
}

function showWarnings(warnings) {
  const el = document.getElementById('warnings-banner');
  el.textContent = '⚠ ' + warnings[0];
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 6000);
}

// ─────────────────────────────────────────────────────────────────────────────
// Three.js setup
// ─────────────────────────────────────────────────────────────────────────────
function initThree() {
  const container = document.getElementById('canvas-container');
  const canvas = document.getElementById('three-canvas');

  // Scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a0f);
  scene.fog = new THREE.Fog(0x0a0a0f, 80, 200);

  // Camera
  camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(20, 18, 20);
  camera.lookAt(0, 0, 0);

  // Renderer
  renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  // Lights
  const ambient = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambient);

  const sun = new THREE.DirectionalLight(0xfff4e0, 1.2);
  sun.position.set(30, 50, 20);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  scene.add(sun);

  const fill = new THREE.DirectionalLight(0x4488ff, 0.3);
  fill.position.set(-20, 10, -20);
  scene.add(fill);

  // Grid
  const grid = new THREE.GridHelper(100, 50, 0x1a1a28, 0x1a1a28);
  grid.position.y = -0.01;
  scene.add(grid);

  // Simple orbit (manual since we can't import OrbitControls from CDN easily)
  setupOrbitControls(canvas);

  // Resize
  window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });

  // Animate
  function animate() {
    animationId = requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  log('Three.js r128 initialized', 'success');
}

// ─────────────────────────────────────────────────────────────────────────────
// Simple orbit controls (mouse drag + scroll)
// ─────────────────────────────────────────────────────────────────────────────
function setupOrbitControls(canvas) {
  let isDragging = false;
  let prevMouse = { x: 0, y: 0 };
  let spherical = { theta: Math.PI / 4, phi: Math.PI / 3.5, radius: 30 };
  let target = new THREE.Vector3(5, 0, 4);

  function updateCamera() {
    camera.position.set(
      target.x + spherical.radius * Math.sin(spherical.phi) * Math.sin(spherical.theta),
      target.y + spherical.radius * Math.cos(spherical.phi),
      target.z + spherical.radius * Math.sin(spherical.phi) * Math.cos(spherical.theta)
    );
    camera.lookAt(target);
  }
  updateCamera();

  canvas.addEventListener('mousedown', (e) => {
    isDragging = true;
    prevMouse = { x: e.clientX, y: e.clientY };
  });

  window.addEventListener('mouseup', () => isDragging = false);

  window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - prevMouse.x;
    const dy = e.clientY - prevMouse.y;
    prevMouse = { x: e.clientX, y: e.clientY };

    if (e.buttons === 1) {
      // Rotate
      spherical.theta -= dx * 0.005;
      spherical.phi = Math.max(0.1, Math.min(Math.PI / 2, spherical.phi + dy * 0.005));
    } else if (e.buttons === 2) {
      // Pan
      const right = new THREE.Vector3();
      const up = new THREE.Vector3(0, 1, 0);
      right.crossVectors(camera.position.clone().sub(target), up).normalize();
      target.addScaledVector(right, -dx * 0.02);
      target.y += dy * 0.02;
    }
    updateCamera();
  });

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    spherical.radius = Math.max(3, Math.min(100, spherical.radius + e.deltaY * 0.05));
    updateCamera();
  }, { passive: false });

  canvas.addEventListener('contextmenu', (e) => e.preventDefault());

  // Expose for reset
  window._orbitState = { spherical, target, updateCamera };
}

// ─────────────────────────────────────────────────────────────────────────────
// Render model
// ─────────────────────────────────────────────────────────────────────────────
function renderModel(model) {
  // Clear previous
  if (buildingGroup) {
    scene.remove(buildingGroup);
    buildingGroup.traverse(obj => {
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) obj.material.dispose();
    });
  }

  buildingGroup = new THREE.Group();

  const wallMat = new THREE.MeshLambertMaterial({ color: 0xc8b89a });
  const wallEdgeMat = new THREE.LineBasicMaterial({ color: 0x8a7a6a, transparent: true, opacity: 0.4 });
  const floorMat = new THREE.MeshLambertMaterial({ color: 0x1e1e2e, side: THREE.DoubleSide });

  // Walls
  model.walls.forEach((wall, i) => {
    const len       = wall.dimensions.width;   // long dimension (wall length)
    const wallH     = wall.dimensions.height;  // vertical
    const thickness = wall.dimensions.depth;   // thin dimension

    const geo = new THREE.BoxGeometry(len, wallH, thickness);
    const mesh = new THREE.Mesh(geo, wallMat.clone());

    // Apply rotation then position using a pivot so they don't interfere
    const pivot = new THREE.Object3D();
    pivot.position.set(wall.position.x, wall.position.y, wall.position.z);
    pivot.rotation.y = wall.rotation_y;
    pivot.add(mesh);

    mesh.castShadow = true;
    mesh.receiveShadow = true;

    // Edge lines
    const edges = new THREE.EdgesGeometry(geo);
    const line = new THREE.LineSegments(edges, wallEdgeMat);
    mesh.add(line);

    buildingGroup.add(pivot);
  });

  // Floor(s)
  model.floors.forEach(floor => {
    const geo = new THREE.PlaneGeometry(floor.dimensions.width, floor.dimensions.depth);
    const mesh = new THREE.Mesh(geo, floorMat);
    mesh.rotation.x = -Math.PI / 2;
    mesh.position.set(floor.position.x, floor.position.y, floor.position.z);
    mesh.receiveShadow = true;
    buildingGroup.add(mesh);
  });

  // Center the group
  const box = new THREE.Box3().setFromObject(buildingGroup);
  const center = box.getCenter(new THREE.Vector3());
  buildingGroup.position.sub(center);

  scene.add(buildingGroup);

  // Hide empty state
  document.getElementById('empty-state').style.display = 'none';

  // Update orbit target
  if (window._orbitState) {
    window._orbitState.target.set(0, 0, 0);
    window._orbitState.updateCamera();
  }

  log(`Rendered ${model.walls.length} walls + ${model.floors.length} floor(s)`, 'success');
}

// ─────────────────────────────────────────────────────────────────────────────
// View controls
// ─────────────────────────────────────────────────────────────────────────────
function resetCamera() {
  if (!window._orbitState) return;
  const s = window._orbitState;
  s.spherical.theta = Math.PI / 4;
  s.spherical.phi = Math.PI / 3.5;
  s.spherical.radius = 30;
  s.target.set(0, 0, 0);
  s.updateCamera();
  isTopView = false;
  document.getElementById('btn-top').classList.remove('active');
  log('Camera reset', 'info');
}

function toggleTopView() {
  if (!window._orbitState) return;
  isTopView = !isTopView;
  const s = window._orbitState;
  if (isTopView) {
    s.spherical.phi = 0.01;
    s.spherical.radius = 40;
  } else {
    s.spherical.phi = Math.PI / 3.5;
    s.spherical.radius = 30;
  }
  s.updateCamera();
  document.getElementById('btn-top').classList.toggle('active', isTopView);
  log(isTopView ? 'Top view enabled' : 'Perspective view', 'info');
}

function toggleWireframe() {
  isWireframe = !isWireframe;
  if (buildingGroup) {
    buildingGroup.traverse(obj => {
      if (obj.isMesh && obj.material) {
        obj.material.wireframe = isWireframe;
      }
    });
  }
  document.getElementById('btn-wireframe').classList.toggle('active', isWireframe);
  log(isWireframe ? 'Wireframe on' : 'Wireframe off', 'info');
}

// ─────────────────────────────────────────────────────────────────────────────
// Keyboard shortcuts
// ─────────────────────────────────────────────────────────────────────────────
window.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  if (e.key === 'r' || e.key === 'R') resetCamera();
  if (e.key === 't' || e.key === 'T') toggleTopView();
  if (e.key === 'w' || e.key === 'W') toggleWireframe();
});

// ─────────────────────────────────────────────────────────────────────────────
// Init
// ─────────────────────────────────────────────────────────────────────────────
initThree();
checkAPI();
</script>
</body>
</html>
