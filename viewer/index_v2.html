<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FloorPlan 3D Viewer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600&display=swap');

    :root {
      --bg: #0a0c0f;
      --surface: #111418;
      --border: #1e2530;
      --accent: #00e5ff;
      --accent2: #ff6b35;
      --text: #c8d4e0;
      --text-dim: #4a5568;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Barlow', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      z-index: 10;
    }

    .logo {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--accent);
      letter-spacing: 0.15em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .header-stats {
      display: flex;
      gap: 24px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .stat span {
      color: var(--accent);
      margin-left: 6px;
    }

    /* â”€â”€ Main layout â”€â”€ */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      width: 260px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
    }

    .sidebar-section {
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }

    .sidebar-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    /* Upload zone */
    .upload-zone {
      border: 1px dashed var(--border);
      border-radius: 4px;
      padding: 20px 12px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--accent);
      background: rgba(0, 229, 255, 0.04);
    }

    .upload-zone input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .upload-icon {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .upload-text {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .upload-text strong {
      color: var(--accent);
      font-weight: 400;
    }

    /* Controls */
    .control-group {
      margin-bottom: 12px;
    }

    .control-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .control-label .val {
      color: var(--accent);
    }

    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 6px var(--accent);
    }

    input[type="number"] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      font-family: var(--mono);
      font-size: 12px;
      border-radius: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus {
      border-color: var(--accent);
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 9px 16px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.1em;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      text-align: center;
      margin-bottom: 8px;
    }

    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn.primary { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.06); }
    .btn.primary:hover { background: rgba(0,229,255,0.12); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }

    /* Toggle buttons */
    .toggle-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      padding: 5px 10px;
      font-family: var(--mono);
      font-size: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 2px;
      transition: all 0.2s;
      letter-spacing: 0.08em;
    }

    .toggle-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0,229,255,0.08);
    }

    /* Info panel */
    .info-row {
      display: flex;
      justify-content: space-between;
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(30,37,48,0.5);
    }

    .info-row:last-child { border-bottom: none; }
    .info-key { color: var(--text-dim); }
    .info-val { color: var(--accent); }

    /* Status log */
    .log {
      font-family: var(--mono);
      font-size: 10px;
      line-height: 1.8;
      color: var(--text-dim);
      max-height: 120px;
      overflow-y: auto;
    }

    .log .entry { display: flex; gap: 8px; }
    .log .entry.ok .msg { color: #48bb78; }
    .log .entry.err .msg { color: #fc8181; }
    .log .entry.info .msg { color: var(--accent); }
    .log .time { color: var(--text-dim); flex-shrink: 0; }

    /* â”€â”€ Canvas â”€â”€ */
    #canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #canvas-container canvas {
      display: block;
    }

    /* Overlay UI */
    .canvas-overlay {
      position: absolute;
      pointer-events: none;
    }

    .overlay-tl {
      top: 16px; left: 16px;
    }

    .overlay-br {
      bottom: 16px; right: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .badge {
      font-family: var(--mono);
      font-size: 10px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      background: rgba(10,12,15,0.85);
      color: var(--text-dim);
      border-radius: 2px;
      letter-spacing: 0.1em;
    }

    .view-label {
      font-family: var(--mono);
      font-size: 20px;
      color: rgba(0,229,255,0.08);
      letter-spacing: 0.3em;
      text-transform: uppercase;
    }

    /* Empty state */
    #empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      pointer-events: none;
    }

    .empty-icon {
      width: 80px; height: 80px;
      border: 1px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      opacity: 0.3;
    }

    .empty-title {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text-dim);
      letter-spacing: 0.15em;
    }

    .empty-sub {
      font-size: 12px;
      color: var(--text-dim);
      opacity: 0.5;
    }

    /* â”€â”€ API status indicator â”€â”€ */
    .api-status {
      display: flex;
      align-items: center;
      gap: 7px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 0.1em;
    }

    .api-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
      transition: background 0.4s, box-shadow 0.4s;
    }

    .api-dot.connected {
      background: #48bb78;
      box-shadow: 0 0 7px #48bb78;
      animation: pulse 2.5s ease-in-out infinite;
    }

    .api-dot.error {
      background: var(--accent2);
      box-shadow: 0 0 7px var(--accent2);
      animation: none;
    }

    /* â”€â”€ Toast notifications â”€â”€ */
    #toast-container {
      position: fixed;
      top: 64px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 3px;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.5;
      max-width: 320px;
      border: 1px solid var(--border);
      background: rgba(10,12,15,0.97);
      backdrop-filter: blur(8px);
      pointer-events: all;
      animation: toast-in 0.2s ease;
      letter-spacing: 0.04em;
    }

    @keyframes toast-in {
      from { opacity: 0; transform: translateX(16px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to   { opacity: 0; transform: translateX(16px); }
    }

    .toast.hiding { animation: toast-out 0.2s ease forwards; }

    .toast.toast-error   { border-color: #fc8181; }
    .toast.toast-warn    { border-color: #f6ad55; }
    .toast.toast-success { border-color: #48bb78; }
    .toast.toast-info    { border-color: var(--accent); }

    .toast-icon { flex-shrink: 0; margin-top: 1px; }
    .toast.toast-error   .toast-icon { color: #fc8181; }
    .toast.toast-warn    .toast-icon { color: #f6ad55; }
    .toast.toast-success .toast-icon { color: #48bb78; }
    .toast.toast-info    .toast-icon { color: var(--accent); }

    .toast-msg { color: var(--text); flex: 1; }
    .toast-close {
      flex-shrink: 0;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 13px;
      line-height: 1;
      padding: 0 2px;
    }
    .toast-close:hover { color: var(--text); }

    /* Loading overlay */
    #loading {
      position: absolute;
      inset: 0;
      background: rgba(10,12,15,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      z-index: 5;
    }

    #loading.visible { display: flex; }

    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--accent);
      letter-spacing: 0.15em;
    }
    /* â”€â”€ Room labels & legend â”€â”€ */
    #room-legend {
      position: absolute;
      bottom: 60px;
      left: 16px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      pointer-events: none;
      z-index: 5;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text);
      background: rgba(10,12,15,0.75);
      padding: 3px 8px;
      border-radius: 4px;
    }
    .legend-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    FLOORPLAN.3D
  </div>
  <div class="header-stats">
    <div class="stat">WALLS <span id="h-walls">â€”</span></div>
    <div class="stat">ROOMS <span id="h-rooms">â€”</span></div>
    <div class="stat">DOORS <span id="h-doors">â€”</span></div>
    <div class="stat">WIN <span id="h-windows">â€”</span></div>
    <div class="stat">LENGTH <span id="h-length">â€”</span></div>
    <div class="stat">BOUNDS <span id="h-bounds">â€”</span></div>
    <div class="stat">TIME <span id="h-time">â€”</span></div>
  </div>
  <div class="api-status">
    <div class="api-dot" id="api-dot"></div>
    <span id="api-label">CONNECTING</span>
  </div>
</header>

<div id="toast-container"></div>

<div class="main">

  <!-- Sidebar -->
  <aside class="sidebar">

    <!-- Upload -->
    <div class="sidebar-section">
      <div class="sidebar-label">Input</div>
      <div class="upload-zone" id="upload-zone">
        <input type="file" id="file-input" accept=".dxf" />
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">
          <strong>Drop DXF file</strong><br>or click to browse
        </div>
      </div>
    </div>

    <!-- Processing options -->
    <div class="sidebar-section">
      <div class="sidebar-label">Processing</div>

      <div class="control-group">
        <div class="control-label">Scale (1 unit = X meters) <span class="val" id="scale-val">1.0</span></div>
        <input type="number" id="scale" value="1.0" step="0.001" min="0.0001" />
      </div>

      <div class="control-group">
        <div class="control-label">Wall Height (m) <span class="val" id="height-val">3.0</span></div>
        <input type="range" id="wall-height" min="2" max="6" step="0.1" value="3.0"
          oninput="document.getElementById('height-val').textContent = this.value" />
      </div>

      <div class="control-group">
        <div class="control-label">Wall Thickness (m) <span class="val" id="thick-val">0.2</span></div>
        <input type="range" id="wall-thickness" min="0.05" max="0.6" step="0.05" value="0.2"
          oninput="document.getElementById('thick-val').textContent = parseFloat(this.value).toFixed(2)" />
      </div>

      <button class="btn primary" id="process-btn" disabled>PROCESS FLOOR PLAN</button>
    </div>

    <!-- View controls -->
    <div class="sidebar-section">
      <div class="sidebar-label">View</div>
      <div class="toggle-group" style="margin-bottom:10px">
        <button class="toggle-btn active" onclick="setView('perspective')">PERSP</button>
        <button class="toggle-btn" onclick="setView('top')">TOP</button>
        <button class="toggle-btn" onclick="setView('front')">FRONT</button>
        <button class="toggle-btn" onclick="setView('side')">SIDE</button>
      </div>
      <div class="toggle-group">
        <button class="toggle-btn active" id="tog-solid" onclick="toggleSolid()">SOLID</button>
        <button class="toggle-btn active" id="tog-wire" onclick="toggleWire()">WIRE</button>
        <button class="toggle-btn active" id="tog-floor" onclick="toggleFloor()">FLOOR</button>
        <button class="toggle-btn active" id="tog-labels" onclick="toggleLabels()">LABELS</button>
        <button class="toggle-btn active" id="tog-doors" onclick="toggleDoors()">DOORS</button>
        <button class="toggle-btn active" id="tog-windows" onclick="toggleWindows()">WIN</button>
      </div>
    </div>

    <!-- Model info -->
    <div class="sidebar-section">
      <div class="sidebar-label">Model Info</div>
      <div id="model-info">
        <div class="info-row"><span class="info-key">status</span><span class="info-val" id="info-status">idle</span></div>
        <div class="info-row"><span class="info-key">walls</span><span class="info-val" id="info-walls">â€”</span></div>
        <div class="info-row"><span class="info-key">rooms</span><span class="info-val" id="info-rooms">â€”</span></div>
        <div class="info-row"><span class="info-key">doors</span><span class="info-val" id="info-doors">â€”</span></div>
        <div class="info-row"><span class="info-key">windows</span><span class="info-val" id="info-windows">â€”</span></div>
        <div class="info-row"><span class="info-key">total length</span><span class="info-val" id="info-length">â€”</span></div>
        <div class="info-row"><span class="info-key">width</span><span class="info-val" id="info-width">â€”</span></div>
        <div class="info-row"><span class="info-key">depth</span><span class="info-val" id="info-depth">â€”</span></div>
        <div class="info-row"><span class="info-key">process time</span><span class="info-val" id="info-time">â€”</span></div>
      </div>
    </div>

    <!-- Log -->
    <div class="sidebar-section" style="flex:1">
      <div class="sidebar-label">Log</div>
      <div class="log" id="log"></div>
    </div>

  </aside>

  <!-- 3D Viewport -->
  <div id="canvas-container">

    <div id="empty-state">
      <div class="empty-icon">ğŸ—</div>
      <div class="empty-title">NO MODEL LOADED</div>
      <div class="empty-sub">Upload a DXF file to begin</div>
    </div>

    <div id="loading">
      <div class="spinner"></div>
      <div class="loading-text" id="loading-text">PROCESSING...</div>
    </div>

    <!-- Room legend -->
    <div id="room-legend"></div>

    <!-- Corner overlays -->
    <div class="canvas-overlay overlay-tl">
      <div class="badge" id="view-badge">PERSPECTIVE</div>
    </div>
    <div class="canvas-overlay overlay-br">
      <div class="badge">ORBIT: drag Â· ZOOM: scroll Â· PAN: right-drag</div>
      <div class="badge" id="shortcut-hint" style="opacity:0.5;font-size:9px">1â€“4: views Â· S/W/F/L: toggles Â· Space: process</div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Config
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = 'http://localhost:8000';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Toast notifications
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info', duration = 4000) {
  const icons = { error: 'âœ•', warn: 'âš ', success: 'âœ“', info: 'â—†' };
  const container = document.getElementById('toast-container');

  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.innerHTML = `
    <span class="toast-icon">${icons[type] || 'â—†'}</span>
    <span class="toast-msg">${msg}</span>
    <span class="toast-close" onclick="dismissToast(this.parentElement)">âœ•</span>
  `;
  container.appendChild(el);

  if (duration > 0) {
    setTimeout(() => dismissToast(el), duration);
  }
  return el;
}

function dismissToast(el) {
  if (!el || el._dismissing) return;
  el._dismissing = true;
  el.classList.add('hiding');
  setTimeout(() => el.remove(), 200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API status check
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAPI() {
  const dot   = document.getElementById('api-dot');
  const label = document.getElementById('api-label');
  try {
    const r = await fetch(`${API}/health`, { signal: AbortSignal.timeout(3000) });
    if (r.ok) {
      dot.className = 'api-dot connected';
      label.textContent = 'API CONNECTED';
      log('Backend connected', 'ok');
    } else {
      throw new Error(`status ${r.status}`);
    }
  } catch (e) {
    dot.className = 'api-dot error';
    label.textContent = 'API OFFLINE';
    log('Backend unreachable â€” is uvicorn running?', 'err');
    toast('Backend offline â€” run: uvicorn app.main:app --reload --port 8000', 'error', 0);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Logging
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type = 'info') {
  const el = document.getElementById('log');
  const now = new Date().toLocaleTimeString('en', {hour12:false});
  const entry = document.createElement('div');
  entry.className = `entry ${type}`;
  entry.innerHTML = `<span class="time">${now}</span><span class="msg">${msg}</span>`;
  el.appendChild(entry);
  el.scrollTop = el.scrollHeight;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Three.js Scene
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scene, camera, renderer, controls;
let wallMeshes = [], wireMeshes = [], floorMesh;
let labelSprites = [];
let showLabels = true;
let doorMeshes = [], windowMeshes = [];
let showDoors = true, showWindows = true;
let showSolid = true, showWire = true, showFloor = true;
let currentView = 'perspective';
let modelLoaded = false;

function initThree() {
  const container = document.getElementById('canvas-container');

  // Scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0c0f);
  scene.fog = new THREE.Fog(0x0a0c0f, 40, 120);

  // Camera
  camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.01, 500);
  camera.position.set(12, 10, 18);
  camera.lookAt(0, 0, 0);

  // Renderer
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  container.appendChild(renderer.domElement);

  // Lighting
  const ambient = new THREE.AmbientLight(0x1a2030, 2);
  scene.add(ambient);

  const dirLight = new THREE.DirectionalLight(0x00e5ff, 1.2);
  dirLight.position.set(10, 20, 10);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = 2048;
  dirLight.shadow.mapSize.height = 2048;
  scene.add(dirLight);

  const fillLight = new THREE.DirectionalLight(0xff6b35, 0.3);
  fillLight.position.set(-10, 5, -10);
  scene.add(fillLight);

  // Grid
  const grid = new THREE.GridHelper(80, 80, 0x1e2530, 0x141820);
  grid.position.y = -0.01;
  scene.add(grid);

  // Orbit controls (manual implementation)
  setupOrbitControls();

  // Resize handler
  window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });

  // Render loop
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  log('Three.js renderer initialized', 'ok');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Orbit Controls (lightweight manual)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupOrbitControls() {
  const canvas = renderer.domElement;
  let isOrbiting = false, isPanning = false;
  let lastX, lastY;
  let spherical = { theta: Math.PI / 4, phi: Math.PI / 3, radius: 25 };
  let target = new THREE.Vector3(5, 0, 4);

  function updateCamera() {
    camera.position.set(
      target.x + spherical.radius * Math.sin(spherical.phi) * Math.sin(spherical.theta),
      target.y + spherical.radius * Math.cos(spherical.phi),
      target.z + spherical.radius * Math.sin(spherical.phi) * Math.cos(spherical.theta)
    );
    camera.lookAt(target);
  }
  updateCamera();

  canvas.addEventListener('mousedown', e => {
    if (e.button === 0) isOrbiting = true;
    if (e.button === 2) isPanning = true;
    lastX = e.clientX; lastY = e.clientY;
  });

  window.addEventListener('mouseup', () => { isOrbiting = false; isPanning = false; });

  window.addEventListener('mousemove', e => {
    if (!isOrbiting && !isPanning) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX; lastY = e.clientY;

    if (isOrbiting) {
      spherical.theta -= dx * 0.008;
      spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi - dy * 0.008));
    }

    if (isPanning) {
      const right = new THREE.Vector3();
      const up = new THREE.Vector3();
      camera.getWorldDirection(up);
      right.crossVectors(up, camera.up).normalize();
      target.addScaledVector(right, -dx * 0.02);
      target.y += dy * 0.02;
    }

    updateCamera();
  });

  canvas.addEventListener('wheel', e => {
    spherical.radius = Math.max(2, Math.min(100, spherical.radius + e.deltaY * 0.05));
    updateCamera();
    e.preventDefault();
  }, { passive: false });

  canvas.addEventListener('contextmenu', e => e.preventDefault());

  // Expose for setView
  window._orbit = { spherical, target, update: updateCamera };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Room label sprites
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createLabelSprite(room) {
  const canvas = document.createElement('canvas');
  canvas.width = 320; canvas.height = 96;
  const ctx = canvas.getContext('2d');

  const hex = room.color || '#2d6a9f';
  ctx.fillStyle = hex + 'cc';
  ctx.beginPath();
  ctx.roundRect(4, 4, 312, 88, 12);
  ctx.fill();

  ctx.strokeStyle = hex;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.roundRect(4, 4, 312, 88, 12);
  ctx.stroke();

  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 26px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(room.label, 160, 36);

  ctx.fillStyle = '#ffffffaa';
  ctx.font = '20px monospace';
  ctx.fillText(room.area.toFixed(1) + ' mÂ²', 160, 66);

  const tex = new THREE.CanvasTexture(canvas);
  const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
  const sprite = new THREE.Sprite(mat);
  const aspect = 320 / 96;
  sprite.scale.set(2.5 * aspect, 2.5, 1);
  sprite.position.set(room.position.x, room.position.y, room.position.z);
  sprite.renderOrder = 999;
  return sprite;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Build 3D model from API response
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildModel(data) {
  // Clear existing
  [...wallMeshes, ...wireMeshes].forEach(m => scene.remove(m));
  if (floorMesh) scene.remove(floorMesh);
  wallMeshes = []; wireMeshes = [];

  const model = data.model;
  if (!model) { log('No model data in response', 'err'); return; }

  // Materials
  const wallMat = new THREE.MeshPhongMaterial({
    color: 0x1a2535,
    emissive: 0x050d1a,
    specular: 0x00e5ff,
    shininess: 30,
  });

  const wireMat = new THREE.LineBasicMaterial({
    color: 0x00e5ff,
    transparent: true,
    opacity: 0.4,
  });

  const floorMat = new THREE.MeshPhongMaterial({
    color: 0x0d1117,
    emissive: 0x050a0f,
    transparent: true,
    opacity: 0.6,
    side: THREE.DoubleSide,
  });

  // Build walls
  model.walls.forEach(w => {
    const geo = new THREE.BoxGeometry(w.dimensions.width, w.dimensions.height, w.dimensions.depth);
    const mesh = new THREE.Mesh(geo, wallMat.clone());
    mesh.position.set(w.position.x, w.position.y, w.position.z);
    mesh.rotation.y = w.rotation_y;
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    scene.add(mesh);
    wallMeshes.push(mesh);

    // Wireframe
    const edges = new THREE.EdgesGeometry(geo);
    const wire = new THREE.LineSegments(edges, wireMat.clone());
    wire.position.copy(mesh.position);
    wire.rotation.copy(mesh.rotation);
    scene.add(wire);
    wireMeshes.push(wire);
  });

  // Build floor
  if (model.floors && model.floors.length > 0) {
    const f = model.floors[0];
    const fgeo = new THREE.PlaneGeometry(f.dimensions.width, f.dimensions.depth);
    floorMesh = new THREE.Mesh(fgeo, floorMat);
    floorMesh.rotation.x = -Math.PI / 2;
    floorMesh.position.set(f.position.x, 0.001, f.position.z);
    floorMesh.receiveShadow = true;
    scene.add(floorMesh);
  }

  // Build doors
  doorMeshes.forEach(m => scene.remove(m));
  doorMeshes = [];
  if (model.doors && model.doors.length > 0) {
    const voidMat = new THREE.MeshPhongMaterial({
      color: 0x050a0f,
      emissive: 0x000000,
    });
    const leafMat = new THREE.MeshPhongMaterial({
      color: 0x8b6914,
      emissive: 0x2a1a00,
      specular: 0xffaa44,
      shininess: 40,
    });
    model.doors.forEach(d => {
      // Door leaf (thin box at 45Â°)
      if (d.leaf) {
        const leaf = d.leaf;
        const lgeo = new THREE.BoxGeometry(leaf.dimensions.width, leaf.dimensions.height, leaf.dimensions.depth);
        const lmesh = new THREE.Mesh(lgeo, leafMat.clone());
        lmesh.position.set(leaf.position.x, leaf.position.y, leaf.position.z);
        lmesh.rotation.y = leaf.rotation_y;
        lmesh.castShadow = true;
        scene.add(lmesh);
        doorMeshes.push(lmesh);
        // Wireframe edge
        const ledge = new THREE.EdgesGeometry(lgeo);
        const lwire = new THREE.LineSegments(ledge, new THREE.LineBasicMaterial({color:0xffaa44,transparent:true,opacity:0.6}));
        lwire.position.copy(lmesh.position); lwire.rotation.copy(lmesh.rotation);
        scene.add(lwire); doorMeshes.push(lwire);
      }
      // Door frame outline (thin lines marking the opening)
      const frameGeo = new THREE.BoxGeometry(d.width, 0.05, d.depth + 0.02);
      const topFrame = new THREE.Mesh(frameGeo, new THREE.MeshPhongMaterial({color:0xffaa44,emissive:0x221100}));
      topFrame.position.set(d.position.x, d.height - 0.025, d.position.z);
      topFrame.rotation.y = d.rotation_y;
      scene.add(topFrame); doorMeshes.push(topFrame);
    });
  }

  // Build windows
  windowMeshes.forEach(m => scene.remove(m));
  windowMeshes = [];
  if (model.windows && model.windows.length > 0) {
    const wallMat2 = new THREE.MeshPhongMaterial({
      color: 0x1a2535, emissive: 0x050d1a,
      specular: 0x00e5ff, shininess: 30,
    });
    const glassMat = new THREE.MeshPhongMaterial({
      color: 0x88ccff,
      emissive: 0x002244,
      transparent: true,
      opacity: 0.35,
      specular: 0xffffff,
      shininess: 120,
      side: THREE.DoubleSide,
    });
    const frameColor = new THREE.LineBasicMaterial({color:0x88ccff,transparent:true,opacity:0.7});
    model.windows.forEach(w => {
      if (!w.pieces) return;
      w.pieces.forEach(p => {
        const mat = p.kind === 'glass' ? glassMat.clone() : wallMat2.clone();
        const geo = new THREE.BoxGeometry(p.dimensions.width, p.dimensions.height, p.dimensions.depth);
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(p.position.x, p.position.y, p.position.z);
        mesh.rotation.y = p.rotation_y;
        mesh.castShadow = (p.kind !== 'glass');
        mesh.receiveShadow = true;
        scene.add(mesh); windowMeshes.push(mesh);
        if (p.kind === 'glass') {
          const edge = new THREE.EdgesGeometry(geo);
          const wire = new THREE.LineSegments(edge, frameColor.clone());
          wire.position.copy(mesh.position); wire.rotation.copy(mesh.rotation);
          scene.add(wire); windowMeshes.push(wire);
        }
      });
    });
  }

  // Build room labels
  labelSprites.forEach(s => scene.remove(s));
  labelSprites = [];
  const legend = document.getElementById('room-legend');
  legend.innerHTML = '';

  if (model.rooms && model.rooms.length > 0) {
    model.rooms.forEach(room => {
      const sprite = createLabelSprite(room);
      scene.add(sprite);
      labelSprites.push(sprite);
      const item = document.createElement('div');
      item.className = 'legend-item';
      item.innerHTML = `<div class="legend-dot" style="background:${room.color}"></div><span>${room.label}</span><span style="color:#6a7a8a;margin-left:4px">${room.area.toFixed(0)}mÂ²</span>`;
      legend.appendChild(item);
    });
  }

  // Update visibility
  applyVisibility();

  // Center camera on model â€” Z is negated (DXF-Y â†’ Three.js -Z)
  const bounds = model.metadata.bounds;
  if (bounds && window._orbit) {
    const cx = (bounds.minx + bounds.maxx) / 2;
    const cz = -((bounds.miny + bounds.maxy) / 2);
    const size = Math.max(bounds.maxx - bounds.minx, bounds.maxy - bounds.miny);
    window._orbit.target.set(cx, 0, cz);
    window._orbit.spherical.radius = size * 2;
    window._orbit.update();
  }

  // Update stats
  const meta = model.metadata;
  document.getElementById('h-walls').textContent = meta.wall_count;
  document.getElementById('h-rooms').textContent = meta.room_count || 0;
  document.getElementById('h-doors').textContent = meta.door_count || 0;
  document.getElementById('h-windows').textContent = meta.window_count || 0;
  document.getElementById('h-length').textContent = meta.total_wall_length + 'm';
  document.getElementById('h-bounds').textContent =
    `${(meta.bounds.maxx - meta.bounds.minx).toFixed(0)}Ã—${(meta.bounds.maxy - meta.bounds.miny).toFixed(0)}m`;
  document.getElementById('h-time').textContent = data.processing_time_ms?.toFixed(0) + 'ms';

  document.getElementById('info-status').textContent = 'loaded';
  document.getElementById('info-walls').textContent = meta.wall_count;
  document.getElementById('info-rooms').textContent = meta.room_count || 0;
  document.getElementById('info-doors').textContent = meta.door_count || 0;
  document.getElementById('info-windows').textContent = meta.window_count || 0;
  document.getElementById('info-length').textContent = meta.total_wall_length + 'm';
  document.getElementById('info-width').textContent = (meta.bounds.maxx - meta.bounds.minx).toFixed(2) + 'm';
  document.getElementById('info-depth').textContent = (meta.bounds.maxy - meta.bounds.miny).toFixed(2) + 'm';
  document.getElementById('info-time').textContent = data.processing_time_ms?.toFixed(1) + 'ms';

  document.getElementById('empty-state').style.display = 'none';
  modelLoaded = true;
  log(`Model built: ${meta.wall_count} walls`, 'ok');

  if (data.warnings?.length) {
    data.warnings.forEach(w => log('âš  ' + w, 'info'));
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Upload + Process flow
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentJobId = null;

async function uploadAndProcess(file) {
  setLoading(true, 'UPLOADING...');
  log(`Uploading: ${file.name}`, 'info');

  try {
    // Upload
    const form = new FormData();
    form.append('file', file);
    const upRes = await fetch(`${API}/upload`, { method: 'POST', body: form });
    if (!upRes.ok) throw new Error(`Upload failed: ${upRes.status}`);
    const upData = await upRes.json();
    currentJobId = upData.job_id;
    log(`Uploaded â†’ job ${currentJobId.slice(0, 8)}â€¦`, 'ok');

    // Process
    setLoading(true, 'PROCESSING...');
    const scale = document.getElementById('scale').value;
    const wallHeight = document.getElementById('wall-height').value;
    const wallThickness = document.getElementById('wall-thickness').value;

    const procRes = await fetch(
      `${API}/process/${currentJobId}?scale=${scale}&wall_height=${wallHeight}&wall_thickness=${wallThickness}`,
      { method: 'POST' }
    );
    if (!procRes.ok) throw new Error(`Process failed: ${procRes.status}`);
    const procData = await procRes.json();

    if (!procData.success) throw new Error(procData.error || 'Processing failed');

    log('Processing complete', 'ok');
    buildModel(procData);

    if (procData.warnings?.length) {
      procData.warnings.forEach(w => toast(w, 'warn', 6000));
    }

  } catch (err) {
    log(err.message, 'err');
    toast(err.message, 'error');
    document.getElementById('info-status').textContent = 'error';
  } finally {
    setLoading(false);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// View controls
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(view) {
  if (!window._orbit) return;
  const { spherical, target, update } = window._orbit;
  currentView = view;

  document.querySelectorAll('.toggle-btn[onclick^="setView"]').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');

  const labels = { perspective: 'PERSPECTIVE', top: 'TOP VIEW', front: 'FRONT VIEW', side: 'SIDE VIEW' };
  document.getElementById('view-badge').textContent = labels[view];

  if (view === 'top') {
    spherical.phi = 0.05;
    spherical.theta = 0;
  } else if (view === 'front') {
    spherical.phi = Math.PI / 2;
    spherical.theta = 0;
  } else if (view === 'side') {
    spherical.phi = Math.PI / 2;
    spherical.theta = Math.PI / 2;
  } else {
    spherical.phi = Math.PI / 3;
    spherical.theta = Math.PI / 4;
  }
  update();
}

function applyVisibility() {
  wallMeshes.forEach(m => m.visible = showSolid);
  wireMeshes.forEach(m => m.visible = showWire);
  if (floorMesh) floorMesh.visible = showFloor;
  labelSprites.forEach(s => s.visible = showLabels);
  doorMeshes.forEach(m => m.visible = showDoors);
  windowMeshes.forEach(m => m.visible = showWindows);
}

function toggleSolid() {
  showSolid = !showSolid;
  document.getElementById('tog-solid').classList.toggle('active', showSolid);
  applyVisibility();
}

function toggleWire() {
  showWire = !showWire;
  document.getElementById('tog-wire').classList.toggle('active', showWire);
  applyVisibility();
}

function toggleFloor() {
  showFloor = !showFloor;
  document.getElementById('tog-floor').classList.toggle('active', showFloor);
  applyVisibility();
}

function toggleLabels() {
  showLabels = !showLabels;
  document.getElementById('tog-labels').classList.toggle('active', showLabels);
  labelSprites.forEach(s => s.visible = showLabels);
  document.getElementById('room-legend').style.display = showLabels ? '' : 'none';
}

function toggleDoors() {
  showDoors = !showDoors;
  document.getElementById('tog-doors').classList.toggle('active', showDoors);
  doorMeshes.forEach(m => m.visible = showDoors);
}

function toggleWindows() {
  showWindows = !showWindows;
  document.getElementById('tog-windows').classList.toggle('active', showWindows);
  windowMeshes.forEach(m => m.visible = showWindows);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(visible, text = 'LOADING...') {
  const el = document.getElementById('loading');
  el.classList.toggle('visible', visible);
  document.getElementById('loading-text').textContent = text;
}

// File input
document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    document.getElementById('process-btn').disabled = false;
    document.getElementById('process-btn').textContent = `PROCESS: ${file.name}`;
    window._pendingFile = file;
    log(`File selected: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'info');
  }
});

// Process button
document.getElementById('process-btn').addEventListener('click', () => {
  if (window._pendingFile) uploadAndProcess(window._pendingFile);
});

// Drag and drop
const zone = document.getElementById('upload-zone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.name.endsWith('.dxf')) {
    window._pendingFile = file;
    document.getElementById('process-btn').disabled = false;
    document.getElementById('process-btn').textContent = `PROCESS: ${file.name}`;
    log(`Dropped: ${file.name}`, 'info');
  } else {
    log('Only .dxf files accepted', 'err');
    toast('Only .dxf files are supported', 'error');
  }
});

// Scale input live update
document.getElementById('scale').addEventListener('input', e => {
  document.getElementById('scale-val').textContent = e.target.value;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyboard shortcuts
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  // Don't fire when typing in an input field
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  const key = e.key.toLowerCase();

  // Views: 1=perspective, 2=top, 3=front, 4=side
  const viewMap = { '1':'perspective', '2':'top', '3':'front', '4':'side' };
  if (viewMap[key]) {
    const view = viewMap[key];
    // Activate correct button visually
    document.querySelectorAll('.toggle-btn[onclick^="setView"]').forEach(b => b.classList.remove('active'));
    const btns = {'perspective':0,'top':1,'front':2,'side':3};
    document.querySelectorAll('.toggle-btn[onclick^="setView"]')[btns[view]]?.classList.add('active');
    // Apply view
    if (!window._orbit) return;
    const { spherical, update } = window._orbit;
    const labels = { perspective:'PERSPECTIVE', top:'TOP VIEW', front:'FRONT VIEW', side:'SIDE VIEW' };
    document.getElementById('view-badge').textContent = labels[view];
    if (view === 'top')         { spherical.phi = 0.05;         spherical.theta = 0; }
    else if (view === 'front')  { spherical.phi = Math.PI/2;    spherical.theta = 0; }
    else if (view === 'side')   { spherical.phi = Math.PI/2;    spherical.theta = Math.PI/2; }
    else                        { spherical.phi = Math.PI/3;    spherical.theta = Math.PI/4; }
    update();
    return;
  }

  // Toggles: S=solid, W=wire, F=floor
  if (key === 's') { toggleSolid(); return; }
  if (key === 'w') { toggleWire();  return; }
  if (key === 'f') { toggleFloor(); return; }
  if (key === 'l') { toggleLabels(); return; }

  // Space = process (if file selected)
  if (key === ' ' || e.code === 'Space') {
    e.preventDefault();
    if (window._pendingFile) uploadAndProcess(window._pendingFile);
    return;
  }

  // R = reset camera to perspective
  if (key === 'r') {
    if (!window._orbit) return;
    const { spherical, update } = window._orbit;
    spherical.phi = Math.PI/3; spherical.theta = Math.PI/4;
    update();
    return;
  }
});

initThree();
checkAPI();
log('Viewer ready â€” upload a DXF to begin', 'ok');
log('Shortcuts: 1-4 views Â· S/W/F/L toggles Â· Space process Â· R reset', 'info');
</script>
</body>
</html>
